<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mx.argal.cp.dao.SolicitudDao">

	<resultMap type="SolicitudCirugiaProgramada" id="solicitudCirugiaProgramadaResult">
		<id property="idSolicitudCirugiaProgramada" column="ID_SOLICITUD_CIRUGIA_PROGRAMADA"/>
		<result property="nombreBeneficiarioSolicitudCirugiaProgramada" column="NOMBRE_BENEFICIARIO"/>
		<result property="apPBeneficiarioSolicitudCirugiaProgramada" column="APP_BENEFICIARIO"/>
		<result property="apMBeneficiarioSolicitudCirugiaProgramada" column="APM_BENEFICIARIO"/>
		<result property="edadBeneficiarioSolicitudCirugiaProgramada" column="EDAD_BENEFICIARIO"/>
		<result property="sexoBeneficiarioSolicitudCirugiaProgramada" column="SEXO_BENEFICIARIO"/>		
		<result property="numNominaBeneficiarioSolicitudCirugiaProgramada" column="NUM_NOMINA_BENEFICIARIO"/>
		<result property="fechaSolicitudCirugiaProgramada" column="FECHA_SOLICITUD"/>
		<result property="fechaSolicitudElaboracion" column="FECHA_SOLICITUD_ELABORACION"/>		
		<result property="empresaBeneficiarioSolicitudCirugiaProgramada" column="EMPRESA_BENEFICIARIO"/>		
		<result property="tipoSolicitudCirugiaProgramada" column="TIPO_CIRUGIA_PROGRAMADA"/>
		<result property="status" column="STATUS"/>	
		<association property="medicoTratante" column="ID_MEDICO_TRATANTE" javaType="MedicoTratante" select="selectMedicoTratante"/>
		<association property="empresa" column="ID_EMPRESA" javaType="Empresa" select="selectEmpresa"/>		
		<association property="cirugiaSolicitadaUno" column="ID_CIRUGIA_SOLICITADA_1" javaType="CirugiaSolicitada" select="selectCirugiaSolicitadaUno"/>
		<!--association property="cirugiaSolicitadaDos" column="ID_CIRUGIA_SOLICITADA" javaType="CirugiaSolicitada" select="selectCirugiaSolicitadaDos"/-->
		<collection property="insumos" column="ID_SOLICITUD_CIRUGIA_PROGRAMADA" javaType="List" select="selectInsumos"/>				
	</resultMap>
	
	<resultMap id="medicoTratanteResult" type="MedicoTratante">
	    	<id property="idMedicoTratante" column="ID_MEDICO_TRATANTE" />
	</resultMap>
	
	<resultMap id="empresaResult" type="Empresa">
	    	<id property="idEmpresa" column="ID_EMPRESA" />
	</resultMap>
	
	<resultMap id="icdResult" type="Icd">
    	<id property="idIcd" column="ID_ICD" />
    	<result property="descripcion" column="DESCRIPCION" />    	
		<result property="clave" column="CVE_ICD" />    		
	</resultMap>
		
	<resultMap id="cptResult" type="Cpt">
    	<id property="idCpt" column="ID_CPT" />
    	<result property="descripcion" column="DESCRIPCION" />
    	<result property="cveCpt" column="CVE_CPT" /> 	    	
	</resultMap>
	
	<resultMap id="insumoResult" type="Insumo">
    	<id property="idInsumo" column="ID_INSUMO" />
    	<result property="descripcion" column="DESCRIPCION" />
    	<result property="monto" column="MONTO" /> 	    	
	</resultMap>
		
	<resultMap id="cirugiaSolicitadaResult" type="CirugiaSolicitada">
	    	<id property="idCirugiaSolicitada" column="ID_CIRUGIA_SOLICITADA" />
	    	<result property="fundamentosDiagnostico" column="FUNDAMENTOS_DIAGNOSTICO"/>
	    	<result property="numCirugia" column="NUM_CIRUGIA"/>	    		    	
	    	<association property="diagnosticoIngreso" column="ID_DIAGNOSTICO_INGRESO" javaType="Icd" select="selectIcd"/>	    		    	
	    	<association property="procedimientoUno" column="ID_PROCEDIMIENTO_1" javaType="ProcedimientoSolicitado" select="selectProcedimientoSolicitadoUno"/>
	    	<association property="procedimientoDos" column="ID_PROCEDIMIENTO_2" javaType="ProcedimientoSolicitado" select="selectProcedimientoSolicitadoDos"/>
	    	<association property="procedimientoTres" column="ID_PROCEDIMIENTO_3" javaType="ProcedimientoSolicitado" select="selectProcedimientoSolicitadoTres"/>
	    	<association property="otrasEnfUno" column="ID_ICD_OTRASENF_1" javaType="Icd" select="selectIcd"/>
	    	<association property="otrasEnfDos" column="ID_ICD_OTRASENF_2" javaType="Icd" select="selectIcd"/>
	    	<association property="otrasEnfTres" column="ID_ICD_OTRASENF_3" javaType="Icd" select="selectIcd"/>
	    	<association property="otrasEnfCuatro" column="ID_ICD_OTRASENF_4" javaType="Icd" select="selectIcd"/>
	    	<association property="otrasEnfCinco" column="ID_ICD_OTRASENF_5" javaType="Icd" select="selectIcd"/>		    		    
	</resultMap>
	
	<resultMap id="procedimientoSolicitadoResult" type="ProcedimientoSolicitado">
	    	<id property="idProcedimientoSolicitado" column="ID_PROCEDIMIENTO_SOLICITADO" />
	    	<result property="autorizado" column="AUTORIZADO"/>
	    	<result property="honorariosMedicosDictaminados" column="HONORARIOS_MED_DICTAMINADOS"/>
	    	<result property="honorariosMedicosNegociados" column="HONORARIOS_MED_NEGOCIADOS"/>
	    	<result property="honorariosMedicosAutorizados" column="HONORARIOS_MED_AUTORIZADOS"/>
	    	<result property="honorariosAyudanteUnoDictaminados" column="HONORARIOS_AY1_DICTAMINADOS"/>
	    	<result property="honorariosAyudanteUnoNegociados" column="HONORARIOS_AY1_NEGOCIADOS"/>
	    	<result property="honorariosAyudanteUnoAutorizados" column="HONORARIOS_AY1_AUTORIZADOS"/>
	    	<result property="honorariosAnestesiologoDictaminados" column="HONORARIOS_ANE_DICTAMINADOS"/>
	    	<result property="honorariosAnestesiologoNegociados" column="HONORARIOS_ANE_NEGOCIADOS"/>
	    	<result property="honorariosAnestesiologoAutorizados" column="HONORARIOS_ANE_AUTORIZADOS"/>
	    	<result property="honorariosAyudanteDosDictaminados" column="HONORARIOS_AY2_DICTAMINADOS"/>
	    	<result property="honorariosAyudanteDosNegociados" column="HONORARIOS_AY2_NEGOCIADOS"/>
	    	<result property="honorariosAyudanteDosAutorizados" column="HONORARIOS_AY2_AUTORIZADOS"/>
	    	<result property="numProcedimiento" column="NUM_PROCEDIMIENTO"/>	    		    	 
	    	<association property="cpt" column="ID_CPT" javaType="Cpt" select="selectCpt"/>	    		    		    		    
	</resultMap>
	
	<select id="selectInsumos" parameterType="int" resultMap="insumoResult" resultType="Insumo">
		select * from "INSUMO" where "ID_SOLICITUD_CIRUGIA_PROGRAMADA"=#{idSolicitudCirugiaProgramada} 	
	</select>
	
	<select id="selectCpt" parameterType="int" resultMap="cptResult" resultType="Cpt">
		select * from "CPT" where "ID_CPT"=#{idCpt} 	
	</select>
	
	<select id="selectProcedimientoSolicitadoUno" parameterType="int" resultMap="procedimientoSolicitadoResult" resultType="ProcedimientoSolicitado">
		select * from "PROCEDIMIENTO_SOLICITADO" where "ID_PROCEDIMIENTO_SOLICITADO"=#{idProcedimientoSolicitado} and "NUM_PROCEDIMIENTO"=1
	</select>
	
	<select id="selectProcedimientoSolicitadoDos" parameterType="int" resultMap="procedimientoSolicitadoResult" resultType="ProcedimientoSolicitado">
		select * from "PROCEDIMIENTO_SOLICITADO" where "ID_PROCEDIMIENTO_SOLICITADO"=#{idProcedimientoSolicitado} and "NUM_PROCEDIMIENTO"=2
	</select>
	
	<select id="selectProcedimientoSolicitadoTres" parameterType="int" resultMap="procedimientoSolicitadoResult" resultType="ProcedimientoSolicitado">
		select * from "PROCEDIMIENTO_SOLICITADO" where "ID_PROCEDIMIENTO_SOLICITADO"=#{idProcedimientoSolicitado} and "NUM_PROCEDIMIENTO"=3
	</select>
	
	<select id="selectIcd" parameterType="int" resultMap="icdResult" resultType="Icd">		 
		select * from "ICD" where "ID_ICD"=#{idIcd} 	
	</select>
	
	<select id="selectMedicoTratante" parameterType="int" resultMap="medicoTratanteResult" resultType="MedicoTratante">		 
		select "ID_MEDICO_TRATANTE" from "MEDICO_TRATANTE" where "ID_MEDICO_TRATANTE"=#{idMedicoTratante} 	
	</select>
	
	<select id="selectEmpresa" parameterType="int" resultMap="empresaResult" resultType="Empresa">		 
		select "ID_EMPRESA" from "EMPRESA" where "ID_EMPRESA"=#{idEmpresa} 	
	</select> 
			
	<select id="selectCirugiaSolicitadaUno" parameterType="int" resultMap="cirugiaSolicitadaResult" resultType="CirugiaSolicitada">		 
		select * from "CIRUGIA_SOLICITADA" where "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada} and "NUM_CIRUGIA"=1 	
	</select>
	
	<select id="selectCirugiaSolicitadaDos" parameterType="int" resultMap="cirugiaSolicitadaResult" resultType="CirugiaSolicitada">		 
		select * from "CIRUGIA_SOLICITADA" where "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada} and "NUM_CIRUGIA"=2 	
	</select> 

	<select id="obtenerSolicitudes" resultMap="solicitudCirugiaProgramadaResult">
		select * from "SOLICITUD_CIRUGIA_PROGRAMADA";
	</select>
	
	<select id="getSolicitudById" resultMap="solicitudCirugiaProgramadaResult">
		select * from "SOLICITUD_CIRUGIA_PROGRAMADA" where "ID_SOLICITUD_CIRUGIA_PROGRAMADA"=#{idSolicitudCirugiaProgramada};
	</select>
	
	<select id="obtenerSolicitudesByMedTrat" parameterType="map" resultMap="solicitudCirugiaProgramadaResult">
		select * from "SOLICITUD_CIRUGIA_PROGRAMADA" where "ID_MEDICO_TRATANTE"=
		(select "ID_MEDICO_TRATANTE" FROM "MEDICO_TRATANTE" WHERE "id_t_usuario"=#{idMedicoTratante});
	</select>
	
	<select id="obtenerSolicitudesByStatus" parameterType="map" resultMap="solicitudCirugiaProgramadaResult">	
		<if test="status != 0">
			select * from "SOLICITUD_CIRUGIA_PROGRAMADA" where "STATUS"=#{status}
		</if>
		<if test="status == 0">
			select * from "SOLICITUD_CIRUGIA_PROGRAMADA"
		</if>		
	</select>
	
	<select id="obtenerCirugiaSolicitadaById" parameterType="map" resultMap="cirugiaSolicitadaResult" resultType="CirugiaSolicitada">		 
		select * from "CIRUGIA_SOLICITADA" where "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada} 	
	</select>	
		
	<insert id="guardarSolicitud" parameterType="SolicitudCirugiaProgramada"  keyProperty="id">
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
  		   	SELECT nextVal('sec_solicitud_c_p')
  		</selectKey>	
		INSERT INTO "SOLICITUD_CIRUGIA_PROGRAMADA"(
			"ID_SOLICITUD_CIRUGIA_PROGRAMADA","STATUS","ID_MEDICO_TRATANTE","FECHA_SOLICITUD_ELABORACION") VALUES (#{id},1,#{medicoTratante.idMedicoTratante},now())
	</insert>
	
	<update id="actualizarCirugiaSolicitada" parameterType="CirugiaSolicitada">		
  			UPDATE "CIRUGIA_SOLICITADA" SET "ID_DIAGNOSTICO_INGRESO" = #{diagnosticoIngreso.id} ,"FUNDAMENTOS_DIAGNOSTICO" =#{fundamentosDiagnostico}			
			WHERE "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada};
			<if test="otrasEnfUno.id!=null">
				UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_1" = #{otrasEnfUno.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada};
			</if>
			<if test="otrasEnfDos.id!=null">
				UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_2" = #{otrasEnfDos.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada};
			</if>
			<if test="otrasEnfTres.id!=null">
				UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_3" = #{otrasEnfTres.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada};
			</if>
			<if test="otrasEnfCuatro.id!=null">
				UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_4" = #{otrasEnfCuatro.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada};
			</if>
			<if test="otrasEnfCinco.id!=null">
				UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_5" = #{otrasEnfCinco.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{idCirugiaSolicitada};
			</if>					
	</update>
	
	<insert id="guardarProcedimientoSolicitado" parameterType="ProcedimientoSolicitado"  keyProperty="id">
		<selectKey keyProperty="idProcedimientoSolicitado" resultType="integer" order="BEFORE">
  		   	SELECT nextVal('sec_procedimiento_solicitado')
  		</selectKey>	  		
  			INSERT INTO "PROCEDIMIENTO_SOLICITADO"("ID_PROCEDIMIENTO_SOLICITADO", "ID_CPT","NUM_PROCEDIMIENTO") VALUES (#{idProcedimientoSolicitado},#{id},#{numProcedimiento});  					
	</insert>
		
	<update id="guardarAsignarProcedimientos" parameterType="CirugiaSolicitada">
		<if test="procedimientoUno.idProcedimientoSolicitado!=null">		
			UPDATE "CIRUGIA_SOLICITADA"
			SET "ID_PROCEDIMIENTO_1"=#{procedimientoUno.idProcedimientoSolicitado} where "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
		<if test="procedimientoDos.idProcedimientoSolicitado!=null">		
			UPDATE "CIRUGIA_SOLICITADA"
			SET "ID_PROCEDIMIENTO_2"=#{procedimientoDos.idProcedimientoSolicitado} where "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
		<if test="procedimientoTres.idProcedimientoSolicitado!=null">		
			UPDATE "CIRUGIA_SOLICITADA"
			SET "ID_PROCEDIMIENTO_3"=#{procedimientoTres.idProcedimientoSolicitado} where "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>	
	</update>
	
	<insert id="guardarSolicitudCirugias" parameterType="CirugiaSolicitada" keyProperty="id"> 
		<selectKey keyProperty="id" resultType="long" order="BEFORE">
  		   	SELECT nextVal('sec_cirugia_solicitada')
  		</selectKey>
		INSERT INTO public."CIRUGIA_SOLICITADA"(
			"ID_CIRUGIA_SOLICITADA", "ID_DIAGNOSTICO_INGRESO", "NUM_CIRUGIA" ,"FUNDAMENTOS_DIAGNOSTICO") 
				VALUES (#{id}, #{diagnosticoIngreso.id}, #{numCirugia}, #{fundamentosDiagnostico});
		<if test="numCirugia==1">
			UPDATE "SOLICITUD_CIRUGIA_PROGRAMADA" SET "ID_CIRUGIA_SOLICITADA_1" =#{id} WHERE "ID_SOLICITUD_CIRUGIA_PROGRAMADA"=#{idCirugiaSolicitada};
		</if>
		<if test="numCirugia==2">
			UPDATE "SOLICITUD_CIRUGIA_PROGRAMADA" SET "ID_CIRUGIA_SOLICITADA_2" =#{id} WHERE "ID_SOLICITUD_CIRUGIA_PROGRAMADA"=#{idCirugiaSolicitada};
		</if>		
		<if test="otrasEnfUno.id!=null">
			UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_1" = #{otrasEnfUno.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
		<if test="otrasEnfDos.id!=null">
			UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_2" = #{otrasEnfDos.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
		<if test="otrasEnfTres.id!=null">
			UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_3" = #{otrasEnfTres.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
		<if test="otrasEnfCuatro.id!=null">
			UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_4" = #{otrasEnfCuatro.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
		<if test="otrasEnfCinco.id!=null">
			UPDATE "CIRUGIA_SOLICITADA" SET "ID_ICD_OTRASENF_5" = #{otrasEnfCinco.id} WHERE "ID_CIRUGIA_SOLICITADA"=#{id};
		</if>
	</insert>
	
	<update id="actualizarSolicitudCirugias" parameterType="CirugiaSolicitada">			  	
  			INSERT INTO public."CIRUGIA_SOLICITADA"(
			"ID_CIRUGIA_SOLICITADA", "ID_DIAGNOSTICO_INGRESO", "NUM_CIRUGIA" ,"FUNDAMENTOS_DIAGNOSTICO") 
				VALUES (#{id}, #{diagnosticoIngreso.idIcd}, #{numCirugia}, #{fundamentosDiagnostico});					
	</update>
	
	<update id="actualizarProcedimientoSolicitado" parameterType="ProcedimientoSolicitado">
		UPDATE "PROCEDIMIENTO_SOLICITADO" SET 
			 "ID_CPT"=#{id}
				 WHERE "ID_PROCEDIMIENTO_SOLICITADO" =#{idProcedimientoSolicitado}				
	</update>	
	
	<update id="guardarSolicitudByParams" parameterType="SolicitudCirugiaProgramada">
			UPDATE "SOLICITUD_CIRUGIA_PROGRAMADA" SET		
		<if test="nombreBeneficiarioSolicitudCirugiaProgramada != null">
			"NOMBRE_BENEFICIARIO"=#{nombreBeneficiarioSolicitudCirugiaProgramada}
		</if>
		<if test="apPBeneficiarioSolicitudCirugiaProgramada != null">
			,"APP_BENEFICIARIO"=#{apPBeneficiarioSolicitudCirugiaProgramada}
		</if>
		<if test="apMBeneficiarioSolicitudCirugiaProgramada != null">
			,"APM_BENEFICIARIO"=#{apMBeneficiarioSolicitudCirugiaProgramada}
		</if>		
		<if test="numNominaBeneficiarioSolicitudCirugiaProgramada != null">	
			,"NUM_NOMINA_BENEFICIARIO"=#{numNominaBeneficiarioSolicitudCirugiaProgramada}
		</if>
		<if test="fechaSolicitudCirugiaProgramada != null">	
			,"FECHA_SOLICITUD"=date(#{fechaSolicitudCirugiaProgramada})
		</if>
		<if test="tipoSolicitudCirugiaProgramada != null">
			,"TIPO_CIRUGIA_PROGRAMADA"=#{tipoSolicitudCirugiaProgramada}
		</if>
		<if test="edadBeneficiarioSolicitudCirugiaProgramada != null">	
			,"EDAD_BENEFICIARIO"=cast(#{edadBeneficiarioSolicitudCirugiaProgramada} as int)
		</if>
		<if test="sexoBeneficiarioSolicitudCirugiaProgramada != null">
			,"SEXO_BENEFICIARIO"=#{sexoBeneficiarioSolicitudCirugiaProgramada}
		</if>
		<if test="medicoTratante != null">	
			,"ID_MEDICO_TRATANTE"=cast(#{medicoTratante.idMedicoTratante} as int)
		</if>
		<if test="empresa != null">	
			,"ID_EMPRESA"=cast(#{empresa.idEmpresa} as int)
		</if>						
			WHERE "ID_SOLICITUD_CIRUGIA_PROGRAMADA"=#{idSolicitudCirugiaProgramada};
	</update>

</mapper>